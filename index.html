<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo</title>

<style>
body{font-family:Arial;margin:100px 20px 20px}
#topbar{position:fixed;top:0;left:0;right:0;background:#222;color:#fff;
padding:10px;display:flex;gap:12px;align-items:center;z-index:1000}
#topbar button{padding:6px 12px;cursor:pointer}
#resumen{margin-left:auto;font-weight:bold}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.card{border:1px solid #ccc;padding:10px;text-align:center}
.codigo{background:#bfe6ff;font-weight:bold;padding:4px}
.card img{max-width:100%;height:168px;object-fit:contain;margin:6px 0;transition:.3s}
.card:hover img{transform:scale(1.5)}
.precio{font-weight:bold;margin:6px 0 10px}
input[type=number]{width:70px}
.seleccionado{background:orange}
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000}
#modalContent{background:#fff;width:90%;max-width:600px;margin:80px auto;padding:15px}
#cerrar{float:right;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
#volverArriba{position:fixed;right:15px;bottom:20px;font-size:36px;cursor:pointer;
background:#222;color:#fff;padding:10px 14px;border-radius:50%;display:none;z-index:1500}
textarea,input[type=text],input[type=date]{width:100%}
</style>
</head>

<body>

<div id="topbar">
<strong>üì¶ Cat√°logo</strong>
<button onclick="exportar()">üíæ Guardar en Excel</button>
<button onclick="abrirCarrito()">üõí Ver carrito</button>
<div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<h2>Datos del pedido</h2>
Raz√≥n Social:<br><input id="razon"><br><br>
Fecha:<br><input type="date" id="fecha"><br><br>
Observaciones:<br><textarea id="obs"></textarea>

<hr>

<div id="estado"></div>
<div id="catalogo" class="grid"></div>

<div id="modal">
  <div id="modalContent">
    <span id="cerrar" onclick="cerrarCarrito()">‚ùå</span>
    <h3>üõí Carrito</h3>
    <div id="lista">Vac√≠o</div>
  </div>
</div>

<div id="volverArriba" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚¨Ü</div>

<script>
let productos=[], carrito=[];

window.addEventListener("load",()=>{
  fetch("./stock.csv?ts=" + Date.now())
    .then(r=>{
      if(!r.ok) throw "error";
      return r.text();
    })
    .then(txt=>{
      estado.innerText="Stock cargado autom√°ticamente ‚úî";
      cargarCSV(txt);
    })
    .catch(()=>{
      estado.innerText="‚ùå No se pudo cargar stock.csv";
    });
});

function cargarCSV(txt){
  productos=[]; carrito=[];
  catalogo.innerHTML=""; lista.innerHTML="Vac√≠o";
  actualizarResumen();

  txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
  let filas=txt.split("\n"); filas.shift();

  filas.forEach((f,i)=>{
    let c=f.split(";");
    if(c.length<2) return;
    let codigo=c[0].trim();
    let precio=parseFloat(c[1].replace(",","."));
    if(!codigo||isNaN(precio)) return;
    productos.push({id:i,codigo,precio,img:"FOTOS/"+codigo+".jpg"});
  });

  dibujar();
}

function dibujar(){
  let h="";
  productos.forEach(p=>{
    h+=`<div class="card">
      <div class="codigo">${p.codigo}</div>
      <img src="${p.img}" onerror="this.style.display='none'">
      <div class="precio">$ ${p.precio.toFixed(2)}</div>
      <input type="number" min="0" value="0" id="q${p.id}"
        onchange="cambiar(${p.id})">
    </div>`;
  });
  catalogo.innerHTML=h;
}

function cambiar(id){
  let i=document.getElementById("q"+id);
  let cant=parseInt(i.value)||0;
  let p=productos.find(x=>x.id===id);
  carrito=carrito.filter(x=>x.id!==id);
  if(cant>0){
    carrito.push({id,codigo:p.codigo,cant,precio:p.precio});
    i.classList.add("seleccionado");
  }else i.classList.remove("seleccionado");
  mostrarCarrito(); actualizarResumen();
}

function mostrarCarrito(){
  if(!carrito.length){lista.innerText="Vac√≠o";return;}
  let t=0,h="<table><tr><th>C√≥digo</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>";
  carrito.forEach(i=>{
    let s=i.cant*i.precio;t+=s;
    h+=`<tr><td>${i.codigo}</td><td>${i.cant}</td><td>${i.precio.toFixed(2)}</td><td>${s.toFixed(2)}</td></tr>`;
  });
  lista.innerHTML=h+`<tr><td colspan="3"><b>Total</b></td><td><b>${t.toFixed(2)}</b></td></tr></table>`;
}

function actualizarResumen(){
  let c=0,t=0;
  carrito.forEach(i=>{c+=i.cant;t+=i.cant*i.precio});
  resumen.innerText=`Cantidad: ${c} | Total: $ ${t.toFixed(2)}`;
}

function abrirCarrito(){modal.style.display="block"}
function cerrarCarrito(){modal.style.display="none"}

window.addEventListener("scroll",()=>{
  volverArriba.style.display=window.scrollY>300?"block":"none";
});
</script>

</body>
</html>
