<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cat√°logo Productos</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body { font-family: Arial; margin: 10px; }
.producto { border:1px solid #ccc; padding:10px; margin:10px; display:inline-block; width:200px; }
img { width:100%; height:150px; object-fit:contain; }

button { padding:10px; margin:5px; font-size:14px; cursor:pointer; }
.btn-activo { background:#2ecc71; color:white; }
.btn-grabando { background:red; color:white; }

#carrito { border-top:2px solid black; margin-top:20px; padding-top:10px; }
</style>
</head>

<body>

<h2>üì¶ Cat√°logo de Productos</h2>

<input type="text" id="buscar" placeholder="Buscar art√≠culo o descripci√≥n">

<div id="productos"></div>

<hr>

<h3>Total: $ <span id="total">0</span></h3>

<button id="btnPDF">GUARDAR PEDIDO EN PDF</button>
<button id="btnCatalogo">DESCARGAR CAT√ÅLOGO</button>
<button id="btnCarrito">VER CARRITO</button>

<div id="carrito"></div>

<script>
let productos = [];
let carrito = [];

// ===== CARGAR CSV =====
fetch("stock.csv")
.then(res => res.text())
.then(data => {
    const lineas = data.split("\n");
    const headers = lineas[0].split(",");

    for(let i=1;i<lineas.length;i++){
        if(!lineas[i].trim()) continue;
        let obj = {};
        let cols = lineas[i].split(",");
        headers.forEach((h,j)=> obj[h.trim()] = cols[j]?.trim());
        productos.push(obj);
    }
    mostrarProductos();
});

// ===== MOSTRAR =====
function mostrarProductos(filtro="") {
    let html = "";
    productos.forEach(p => {
        if(filtro && !p.descripcion.toLowerCase().includes(filtro) && !p.articulo.toLowerCase().includes(filtro)) return;

        html += `
        <div class="producto">
            <img src="FOTOS/${p.foto}">
            <b>${p.articulo}</b><br>
            ${p.descripcion}<br>
            $ ${Number(p.precio).toLocaleString()}<br>
            <button onclick="agregar('${p.articulo}',${p.precio})">Agregar</button>
        </div>`;
    });
    document.getElementById("productos").innerHTML = html;
}

// ===== BUSCAR =====
document.getElementById("buscar").addEventListener("keyup", e=>{
    mostrarProductos(e.target.value.toLowerCase());
});

// ===== AGREGAR =====
function agregar(art, precio){
    carrito.push({art,precio});
    actualizarCarrito();
}

// ===== ACTUALIZAR =====
function actualizarCarrito(){
    let total = carrito.reduce((s,i)=>s+i.precio,0);
    document.getElementById("total").innerText = total.toLocaleString();

    let html = "";
    carrito.forEach(i => html += `<div>${i.art} - $${i.precio.toLocaleString()}</div>`);
    document.getElementById("carrito").innerHTML = html;

    activarBotones(total>0);
}

// ===== BOTONES VERDES =====
function activarBotones(activo){
    let botones = ["btnPDF","btnCatalogo","btnCarrito"];
    botones.forEach(id=>{
        let b = document.getElementById(id);
        if(activo) b.classList.add("btn-activo");
        else b.classList.remove("btn-activo");
    });
}

// ===== PDF PEDIDO =====
document.getElementById("btnPDF").onclick = async ()=>{
    if(carrito.length==0) return;

    let b = document.getElementById("btnPDF");
    b.innerText="Grabando...";
    b.classList.add("btn-grabando");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text("PEDIDO",10,10);
    let y=20;
    carrito.forEach(i=>{
        doc.text(`${i.art} - $${i.precio}`,10,y);
        y+=10;
    });
    doc.text("TOTAL: $"+document.getElementById("total").innerText,10,y+10);

    doc.save("pedido.pdf");

    b.innerText="GUARDAR PEDIDO EN PDF";
    b.classList.remove("btn-grabando");
};

// ===== PDF CATALOGO =====
document.getElementById("btnCatalogo").onclick = async ()=>{
    let b = document.getElementById("btnCatalogo");
    b.innerText="Grabando...";
    b.classList.add("btn-grabando");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y=10;

    productos.forEach(p=>{
        doc.text(`${p.articulo} - ${p.descripcion} - $${p.precio}`,10,y);
        y+=8;
        if(y>280){ doc.addPage(); y=10; }
    });

    doc.save("catalogo.pdf");

    b.innerText="DESCARGAR CAT√ÅLOGO";
    b.classList.remove("btn-grabando");
};

// ===== VER CARRITO =====
document.getElementById("btnCarrito").onclick = ()=>{
    alert("Carrito:\n"+carrito.map(i=>i.art+" $"+i.precio).join("\n"));
};
</script>

</body>
</html>
