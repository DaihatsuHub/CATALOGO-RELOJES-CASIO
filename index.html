<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CATALOGO RELOJES</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { font-family: Arial; margin:0; padding-top:120px; background:#f5f5f5; }
header {
  position:fixed; top:0; left:0; width:100%; background:#222; color:white; padding:10px; z-index:9999;
}
#totales { font-size:18px; }
input { padding:5px; }

.catalogo {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(180px,1fr));
  gap:10px;
  padding:10px;
}

.item {
  background:white;
  border:1px solid #ccc;
  padding:5px;
  text-align:center;
}

.codigo {
  background:#cce5ff;
  font-weight:bold;
  padding:3px;
}

.item img {
  width:120px;
  transition:0.3s;
}

.item img:hover {
  transform:scale(1.5);
  z-index:999;
}

.precio {
  font-weight:bold;
  text-align:center;
  margin-top:5px;
}

button {
  padding:8px;
  margin:3px;
  font-size:14px;
}

.verde {
  background:green;
  color:white;
}

#popup {
  display:none;
  position:fixed;
  top:10%;
  left:10%;
  width:80%;
  height:80%;
  background:white;
  border:2px solid black;
  padding:10px;
  overflow:auto;
  z-index:99999;
}

#progressCatalogo {
  display:none;
  width:100%;
  background:#ddd;
  border-radius:5px;
}

#progressCatalogoBar {
  width:0%;
  height:20px;
  background:green;
  color:white;
  text-align:center;
}
</style>
</head>

<body>

<header>
  üîé Buscar: <input id="buscar" oninput="filtrar()">

  <div id="totales">
    Cantidad: <span id="totalCantidad">0</span> |
    Total $ <span id="totalImporte">0</span>
  </div>

  Raz√≥n Social: <input id="razon">
  Fecha: <input id="fecha" type="date">
  Observaciones: <input id="obs">

  <br>

  <button id="btnCarrito" onclick="mostrarCarrito()">VER CARRITO</button>
  <button id="btnPedido" onclick="guardarPedido()">GUARDAR PEDIDO PDF</button>
  <button id="btnCatalogo" onclick="descargarCatalogo()">DESCARGAR CAT√ÅLOGO</button>

  <div id="progressCatalogo">
    <div id="progressCatalogoBar">0%</div>
  </div>
</header>

<div id="catalogo" class="catalogo"></div>

<div id="popup">
  <h2>üõí CARRITO</h2>
  <div id="tablaCarrito"></div>
  <button onclick="cerrarCarrito()">Cerrar</button>
</div>

<script>
let productos = [];
let carrito = {};

function cargarCSV() {
  Papa.parse("STOCK.CSV", {
    download:true,
    header:true,
    complete: function(res) {
      productos = res.data;
      mostrarCatalogo(productos);
    }
  });
}

function mostrarCatalogo(lista) {
  const div = document.getElementById("catalogo");
  div.innerHTML = "";
  lista.forEach(p => {
    if(!p.CODIGO) return;
    const foto = "FOTOS/" + p.CODIGO + ".jpg";
    div.innerHTML += `
      <div class="item">
        <div class="codigo">${p.CODIGO}</div>
        <img src="${foto}">
        <div class="precio">$ ${p.PRECIO}</div>
        Cantidad:<br>
        <input type="number" min="0" value="0" oninput="agregar('${p.CODIGO}', this.value, ${p.PRECIO})">
      </div>
    `;
  });
}

function agregar(cod, cant, precio) {
  cant = parseInt(cant);
  if(cant>0) carrito[cod] = {cant, precio};
  else delete carrito[cod];
  actualizarTotales();
}

function actualizarTotales() {
  let totalC=0, totalI=0;
  for(let c in carrito){
    totalC += carrito[c].cant;
    totalI += carrito[c].cant * carrito[c].precio;
  }
  document.getElementById("totalCantidad").innerText = totalC;
  document.getElementById("totalImporte").innerText = totalI.toLocaleString();

  ["btnCarrito","btnPedido","btnCatalogo"].forEach(id=>{
    document.getElementById(id).classList.toggle("verde", totalC>0);
  });
}

function filtrar() {
  const t = document.getElementById("buscar").value.toLowerCase();
  const f = productos.filter(p => 
    p.CODIGO.toLowerCase().includes(t) || 
    (p.DESCRIPCION||"").toLowerCase().includes(t)
  );
  mostrarCatalogo(f);
}

function mostrarCarrito() {
  let html = "<table border=1 width=100%><tr><th>C√≥digo</th><th>Cantidad</th><th>Precio</th></tr>";
  for(let c in carrito){
    html += `<tr><td>${c}</td><td>${carrito[c].cant}</td><td>$${carrito[c].precio}</td></tr>`;
  }
  html += "</table>";
  document.getElementById("tablaCarrito").innerHTML = html;
  document.getElementById("popup").style.display="block";
}

function cerrarCarrito() {
  document.getElementById("popup").style.display="none";
}

async function guardarPedido() {
  const div = document.createElement("div");
  div.innerHTML = `
    <h2>PEDIDO RELOJES CASIO</h2>
    <b>Raz√≥n Social:</b> ${razon.value}<br>
    <b>Fecha:</b> ${fecha.value}<br>
    <b>Observaciones:</b> ${obs.value}<br><br>
    ${document.getElementById("tablaCarrito").innerHTML}
  `;
  await html2pdf().from(div).save("PEDIDO.pdf");
}

async function descargarCatalogo() {
  const btn = btnCatalogo;
  const prog = progressCatalogo;
  const bar = progressCatalogoBar;

  btn.innerText="Grabando...";
  btn.style.color="red";
  prog.style.display="block";
  bar.style.width="0%";
  bar.innerText="0%";

  let p=0;
  const timer = setInterval(()=>{
    p+=5;
    if(p<=90){
      bar.style.width=p+"%";
      bar.innerText=p+"%";
    }
  },200);

  await html2pdf().set({
    filename:"CATALOGO_RELOJES.pdf",
    image:{type:"jpeg", quality:0.6},
    html2canvas:{scale:1.2,useCORS:true},
    jsPDF:{unit:"mm",format:"a4"}
  }).from(document.getElementById("catalogo")).save();

  clearInterval(timer);
  bar.style.width="100%";
  bar.innerText="100%";

  setTimeout(()=>{
    prog.style.display="none";
    btn.innerText="DESCARGAR CAT√ÅLOGO";
    btn.style.color="black";
  },1000);
}

cargarCSV();
</script>

</body>
</html>
