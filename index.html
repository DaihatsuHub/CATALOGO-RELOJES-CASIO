<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo Relojes</title>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:100px 20px 20px}

/* TOP BAR */
#topbar{
 position:fixed;top:0;left:0;right:0;
 background:#222;color:#fff;padding:10px;
 display:flex;gap:12px;align-items:center;z-index:1000
}
#topbar button{padding:6px 12px;cursor:pointer}
#resumen{margin-left:auto;font-weight:bold}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.card{border:1px solid #ccc;padding:10px;text-align:center}
.codigo{background:#bfe6ff;font-weight:bold;padding:4px}
.card img{max-width:100%;height:150px;object-fit:contain;margin:6px 0;transition:.3s}
.card:hover img{transform:scale(1.3)}
.precio{font-weight:bold}
input[type=number]{width:70px}
.seleccionado{background:orange}

/* MODAL */
#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000}
#modalContent{background:#fff;width:90%;max-width:700px;margin:80px auto;padding:15px}
#cerrar{float:right;cursor:pointer}

/* TABLE */
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}

/* BOTONES */
.boton-activo{background:green!important;color:white!important}

/* BARRA PROGRESO */
#progresoBox{
 position:fixed;top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:white;border:2px solid #222;
 padding:20px;width:300px;display:none;z-index:3000
}
#barra{
 width:100%;height:20px;border:1px solid #000;
}
#barra div{
 height:100%;width:0%;
 background:green;color:white;text-align:center;font-size:12px
}
</style>
</head>

<body>

<div id="topbar">
  <b>üì¶ Cat√°logo</b>
  <input type="text" id="busqueda" placeholder="Buscar c√≥digo..." oninput="filtrar()">
  <button id="btnPDF">üì• Descargar Pedido</button>
  <button id="btnCatalogo">üìò Descargar Cat√°logo</button>
  <button id="btnCarrito">üõí Ver carrito</button>
  <div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<h2>Datos del pedido</h2>
Raz√≥n Social:<br><input type="text" id="razon"><br><br>
Fecha:<br><input type="date" id="fecha"><br><br>
Observaciones:<br><textarea id="obs" rows="3"></textarea>
<hr>

<div id="estado"></div>
<div id="catalogo" class="grid"></div>

<!-- MODAL CARRITO -->
<div id="modal">
 <div id="modalContent">
  <span id="cerrar">‚ùå</span>
  <h3>üõí Carrito</h3>
  <div id="lista">Vac√≠o</div>
 </div>
</div>

<!-- BARRA PROGRESO -->
<div id="progresoBox">
  <b>Generando cat√°logo PDF...</b><br><br>
  <div id="barra"><div></div></div>
</div>

<script>
const btnPDF=document.getElementById("btnPDF");
const btnCatalogo=document.getElementById("btnCatalogo");
const btnCarrito=document.getElementById("btnCarrito");
const modal=document.getElementById("modal");
const cerrar=document.getElementById("cerrar");
const resumen=document.getElementById("resumen");
const lista=document.getElementById("lista");
const catalogo=document.getElementById("catalogo");
const estado=document.getElementById("estado");
const busqueda=document.getElementById("busqueda");
const progresoBox=document.getElementById("progresoBox");
const barra=document.querySelector("#barra div");

let productos=[], carrito=[];
fecha.value=new Date().toISOString().split("T")[0];

/* CARGA CSV */
window.addEventListener("load",()=>{
 fetch("stock.csv").then(r=>r.text()).then(txt=>{
  estado.innerText="Stock cargado ‚úî";
  cargarCSV(txt);
 }).catch(()=>estado.innerText="No se pudo cargar stock.csv");
});

function cargarCSV(txt){
 txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
 const filas=txt.split("\n");filas.shift();
 filas.forEach((f,i)=>{
  const c=f.split(";");
  if(c.length<2)return;
  const codigo=c[0].trim();
  const precio=parseFloat(c[1].replace(",","."))||0;
  const carpeta=codigo[0].toUpperCase()>="M"?"FOTOS2":"FOTOS";
  productos.push({id:i,codigo,precio,img:carpeta+"/"+codigo+".jpg"});
 });
 dibujar();
}

function dibujar(){
 catalogo.innerHTML=productos.map(p=>`
 <div class="card">
  <div class="codigo">${p.codigo}</div>
  <img src="${p.img}" onerror="this.style.display='none'">
  <div class="precio">$ ${p.precio.toFixed(2)}</div>
  <input type="number" min="0" value="0" id="q${p.id}" oninput="cambiar(${p.id})">
 </div>`).join("");
}

/* CARRITO */
function cambiar(id){
 const input=document.getElementById("q"+id);
 const cant=parseInt(input.value)||0;
 const p=productos.find(x=>x.id===id);

 // Buscar si ya existe en carrito
 let item = carrito.find(x=>x.codigo===p.codigo);

 if(cant>0){
   if(item){
     // actualizar cantidad
     item.cant = cant;
   } else {
     // agregar nuevo
     carrito.push({codigo:p.codigo,cant,precio:p.precio});
   }
   input.classList.add("seleccionado");
 } else {
   // eliminar si cantidad = 0
   carrito = carrito.filter(x=>x.codigo!==p.codigo);
   input.classList.remove("seleccionado");
 }

 // ordenar alfab√©tico
 carrito.sort((a,b)=>a.codigo.localeCompare(b.codigo));

 mostrarCarrito();
 actualizarResumen();
}


function mostrarCarrito(){
 if(!carrito.length){lista.innerText="Vac√≠o";return;}
 let total=0;
 lista.innerHTML=`<table><tr><th>C√≥digo</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>
 ${carrito.map(i=>{const s=i.cant*i.precio;total+=s;return `<tr><td>${i.codigo}</td><td>${i.cant}</td><td>$${i.precio.toFixed(2)}</td><td>$${s.toFixed(2)}</td></tr>`}).join("")}
 <tr><td colspan=3><b>Total</b></td><td><b>$${total.toFixed(2)}</b></td></tr></table>`;
}

function actualizarResumen(){
 let c=0,t=0;
 carrito.forEach(i=>{c+=i.cant;t+=i.cant*i.precio});
 resumen.innerText=`Cantidad: ${c} | Total: $ ${t.toFixed(2)}`;
 const activo=t>0;
 [btnPDF,btnCatalogo,btnCarrito].forEach(b=>b.classList.toggle("boton-activo",activo));
}

btnCarrito.onclick=()=>modal.style.display="block";
cerrar.onclick=()=>modal.style.display="none";

function filtrar(){
 const txt=busqueda.value.toLowerCase();
 document.querySelectorAll(".card").forEach(c=>{
  c.style.display=c.querySelector(".codigo").innerText.toLowerCase().includes(txt)?"":"none";
 });
}

/* PDF PEDIDO */
btnPDF.onclick=()=>{
 if(!carrito.length){alert("Carrito vac√≠o");return;}
 const {jsPDF}=window.jspdf;
 const doc=new jsPDF();
 let y=10;
 doc.text("PEDIDO CASIO",10,y);y+=8;
 doc.text("Razon Social: "+razon.value,10,y);y+=6;
 doc.text("Fecha: "+fecha.value,10,y);y+=6;
 doc.text("Obs: "+obs.value,10,y);y+=10;
 let total=0;
 carrito.forEach(i=>{
  const s=i.cant*i.precio;total+=s;
  doc.text(`${i.codigo}  ${i.cant} x $${i.precio}`,10,y);y+=6;
 });
 doc.text("TOTAL: $"+total.toFixed(2),10,y+5);
 doc.save("PEDIDO_CASIO.pdf");
};

/* PDF CATALOGO CON BARRA */
btnCatalogo.onclick = async ()=>{
 progresoBox.style.display="block";
 barra.style.width="0%"; barra.innerText="0%";

 const {jsPDF}=window.jspdf;
 const doc=new jsPDF("p","mm","a4");

 const cols=7;
 const cellW=190/cols;
 const cellH=42;   // un poco m√°s alto para que no se salga nada

 let x=10,y=10,col=0;

 for(let i=0;i<productos.length;i++){
  const p=productos[i];

  // Marco
  doc.setDrawColor(0);
  doc.rect(x,y,cellW,cellH);

  // ===== CODIGO (barra celeste) =====
  doc.setFillColor(191,230,255);
  doc.rect(x,y,cellW,6,"F");
  doc.setFont("helvetica","bold");
  doc.setFontSize(7);
  doc.text(p.codigo,x+cellW/2,y+4,{align:"center"});

  // ===== IMAGEN PROPORCIONAL =====
  try{
    const imgData = await fetch(p.img).then(r=>r.blob()).then(b=>new Promise(res=>{
      const fr=new FileReader();
      fr.onload=()=>res(fr.result);
      fr.readAsDataURL(b);
    }));

    // caja imagen
    const maxW = cellW-4;
    const maxH = 20;

    // jsPDF no sabe tama√±o real, usamos tama√±o fijo proporcional
    doc.addImage(imgData,"JPEG",x+2,y+8,maxW,maxH,undefined,"FAST");

  }catch{}

  // ===== PRECIO =====
  doc.setFont("helvetica","bold");
  doc.setFontSize(8);
  doc.text("$"+p.precio.toFixed(2),x+cellW/2,y+34,{align:"center"});

  // ===== GRID =====
  col++;
  x+=cellW;
  if(col===cols){
    col=0;
    x=10;
    y+=cellH;
    if(y>260){
      doc.addPage();
      y=10;
    }
  }

  // PROGRESO
  let pct=Math.round((i+1)/productos.length*100);
  barra.style.width=pct+"%";
  barra.innerText=pct+"%";
  await new Promise(r=>setTimeout(r,3));
 }

 progresoBox.style.display="none";
 doc.save("CATALOGO_RELOJES.pdf");
};

</script>

</body>
</html>
