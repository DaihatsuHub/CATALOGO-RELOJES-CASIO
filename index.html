<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CatÃ¡logo Relojes</title>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:100px 20px 20px}
#topbar{
  position:fixed;top:0;left:0;right:0;
  background:#222;color:#fff;padding:10px;
  display:flex;gap:12px;align-items:center;z-index:1000
}
#topbar button{padding:6px 12px;cursor:pointer}
#resumen{margin-left:auto;font-weight:bold}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px}
.card{border:1px solid #ccc;padding:10px;text-align:center}
.codigo{background:#bfe6ff;font-weight:bold;padding:4px}
.card img{max-width:100%;height:168px;object-fit:contain;margin:6px 0}
.precio{font-weight:bold;margin:6px 0 10px}
input[type=number]{width:70px}
.seleccionado{background:orange}
.boton-activo{background:green!important;color:#fff!important}
</style>
</head>

<body>

<div id="topbar">
  <strong>ðŸ“¦ CatÃ¡logo</strong>
  <input type="text" id="busqueda" placeholder="Buscar cÃ³digo..." oninput="filtrar()">
  <button id="btnPDF" onclick="guardarPDF()">ðŸ“„ Guardar en PDF</button>
  <button id="btnCarrito" onclick="abrirCarrito()">ðŸ›’ Ver carrito</button>
  <div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<h2>Datos del pedido</h2>
RazÃ³n Social:<br>
<input type="text" id="razon"><br><br>
Fecha:<br>
<input type="date" id="fecha"><br><br>
Observaciones:<br>
<textarea id="obs" rows="3"></textarea>

<hr>
<div id="estado"></div>
<div id="catalogo" class="grid"></div>

<script>
let productos=[], carrito=[];
fecha.value = new Date().toISOString().split("T")[0];

window.addEventListener("load",()=>{
  fetch("stock.csv")
    .then(r=>r.text())
    .then(txt=>{
      estado.innerText="Stock cargado automÃ¡ticamente âœ”";
      cargarCSV(txt);
    })
    .catch(()=>estado.innerText="No se pudo cargar stock");
});

function cargarCSV(txt){
  productos=[]; carrito=[]; catalogo.innerHTML="";
  txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
  const filas=txt.split("\n");
  filas.shift();

  filas.forEach((f,i)=>{
    const c=f.split(";");
    if(c.length<2) return;

    const codigo=c[0].trim();
    const precio=parseFloat(c[1].replace(",","."))||0;
    if(!codigo) return;

    const carpeta = codigo[0].toUpperCase() >= "M" ? "FOTOS2" : "FOTOS";

    productos.push({
      id:i,
      codigo,
      precio,
      img:`${carpeta}/${codigo}.jpg`
    });
  });
  dibujar();
}

function dibujar(){
  catalogo.innerHTML = productos.map(p=>`
    <div class="card">
      <div class="codigo">${p.codigo}</div>
      <img src="${p.img}" onerror="this.style.display='none'">
      <div class="precio">$ ${p.precio.toFixed(2)}</div>
      <input type="number" min="0" value="0" id="q${p.id}" onchange="cambiar(${p.id})">
    </div>
  `).join("");
}

function cambiar(id){
  const q=document.getElementById("q"+id);
  const cant=parseInt(q.value)||0;
  const p=productos.find(x=>x.id===id);
  carrito=carrito.filter(x=>x.id!==id);

  if(cant>0){
    carrito.push({id,codigo:p.codigo,cant,precio:p.precio});
    q.classList.add("seleccionado");
  }else q.classList.remove("seleccionado");

  actualizarResumen();
}

function actualizarResumen(){
  let c=0,t=0;
  carrito.forEach(i=>{c+=i.cant;t+=i.cant*i.precio});
  resumen.innerText=`Cantidad: ${c} | Total: $ ${t.toFixed(2)}`;
}
</script>

</body>
</html>
