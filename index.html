<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CatÃ¡logo Relojes</title>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:100px 20px 20px}
#topbar{
  position:fixed;top:0;left:0;right:0;
  background:#222;color:#fff;padding:10px;
  display:flex;gap:10px;align-items:center;z-index:1000
}
#topbar button{padding:6px 12px;cursor:pointer}
#resumen{margin-left:auto;font-weight:bold}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px
}
.card{border:1px solid #ccc;padding:10px;text-align:center}
.codigo{background:#bfe6ff;font-weight:bold;padding:4px}
.card img{
  max-width:100%;
  height:168px;
  object-fit:contain;
  margin:6px 0;
  transition:transform .3s
}
.card:hover img{transform:scale(1.4)}
.precio{font-weight:bold;margin-bottom:8px}
input[type=number]{width:70px}
.seleccionado{background:orange}
</style>
</head>

<body>

<div id="topbar">
  <strong>ðŸ“¦ CatÃ¡logo</strong>
  <input type="text" id="busqueda" placeholder="Buscar cÃ³digo..." oninput="filtrar()">
  <button onclick="descargarCatalogoPDF()">ðŸ“˜ Descargar CatÃ¡logo</button>
  <div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<hr>
<div id="estado"></div>
<div id="catalogo" class="grid"></div>

<script>
const { jsPDF } = window.jspdf;

let productos=[];

/* ===== CARGA CSV ===== */
fetch("stock.csv")
.then(r=>r.text())
.then(txt=>{
  estado.innerText="Stock cargado âœ”";
  txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
  const filas=txt.split("\n"); filas.shift();
  filas.forEach((f,i)=>{
    const c=f.split(";");
    if(c.length<2) return;
    const codigo=c[0].trim();
    const precio=parseFloat(c[1].replace(",","."))||0;
    const carpeta=codigo[0].toUpperCase()>="M"?"FOTOS2":"FOTOS";
    productos.push({codigo,precio,img:`${carpeta}/${codigo}.jpg`});
  });
  dibujar();
});

function dibujar(){
  catalogo.innerHTML=productos.map(p=>`
    <div class="card">
      <div class="codigo">${p.codigo}</div>
      <img src="${p.img}">
      <div class="precio">$ ${p.precio.toFixed(2)}</div>
    </div>
  `).join("");
}

function filtrar(){
  const t=busqueda.value.toLowerCase();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display=c.innerText.toLowerCase().includes(t)?"":"none";
  });
}

/* ===== PDF CATÃLOGO MEJORADO ===== */
async function descargarCatalogoPDF(){
  const doc=new jsPDF("p","mm","a4");

  const cols=7;
  const x0=10;
  const cellW=27;
  const cellH=38;

  let x=x0, y=20, col=0;

  doc.setFont("helvetica","bold");
  doc.text("CATÃLOGO RELOJES CASIO",10,10);

  for(const p of productos){

    /* Marco */
    doc.rect(x,y,cellW,cellH);

    /* Fondo cÃ³digo */
    doc.setFillColor(191,230,255);
    doc.rect(x,y,cellW,6,"F");

    /* CÃ³digo ajustado */
    doc.setTextColor(0);
    doc.setFontSize(7);
    doc.text(p.codigo,x+cellW/2,y+4,{align:"center",maxWidth:cellW-2});

    /* Imagen */
    try{
      const img=await imgLow(p.img);
      doc.addImage(img,"JPEG",x+2,y+7,cellW-4,22);
    }catch{}

    /* Precio */
    doc.setFontSize(8);
    doc.text("$ "+p.precio.toFixed(2),x+cellW/2,y+35,{align:"center"});

    col++;
    x+=cellW;

    if(col===cols){
      col=0;
      x=x0;
      y+=cellH+4;
      if(y>260){
        doc.addPage();
        y=20;
      }
    }
  }
  doc.save("CATALOGO_CASIO.pdf");
}

/* ===== IMAGEN LIVIANA ===== */
function imgLow(src){
  return new Promise((ok,fail)=>{
    const i=new Image();
    i.crossOrigin="anonymous";
    i.onload=()=>{
      const c=document.createElement("canvas");
      c.width=i.width;
      c.height=i.height;
      c.getContext("2d").drawImage(i,0,0);
      ok(c.toDataURL("image/jpeg",0.5));
    };
    i.onerror=fail;
    i.src=src;
  });
}
</script>

</body>
</html>
