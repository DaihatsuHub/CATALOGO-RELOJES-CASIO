<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CatÃ¡logo</title>

<!-- ===== LIBRERIA XLSX ===== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{
  font-family: Arial;
  margin:120px 20px 20px 20px;
}

/* ===== BARRA SUPERIOR ===== */
#topbar{
  position:fixed;
  top:0;
  left:0;
  right:0;
  background:#222;
  color:#fff;
  padding:10px;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:1000;
  flex-wrap:wrap;
}
#topbar button{ padding:6px 12px; cursor:pointer; }

#buscador{ padding:6px; min-width:180px; }
#resumen{ margin-left:auto; font-weight:bold; }

/* ===== GRILLA ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
}
.card{ border:1px solid #ccc; padding:0; text-align:center; }

.codigo-barra{
  background:#cfe8ff;
  padding:6px;
  font-weight:bold;
}

.card img{
  max-width:100%;
  height:145px;
  object-fit:contain;
  margin:6px 0;
}

.card-contenido{ padding:10px; }

.precio{
  font-weight:bold;
  text-align:center;
  margin:6px 0 10px 0;
}

input[type=number]{ width:70px; }
.seleccionado{ background:orange; }

#carritoBox{ display:none; margin-top:20px; }

table{ width:100%; border-collapse:collapse; }
th,td{ border:1px solid #ccc; padding:6px; text-align:center; }

textarea, input[type=text], input[type=date]{ width:100%; }
</style>
</head>

<body>

<div id="topbar">
  <strong>ðŸ“¦ CatÃ¡logo</strong>
  <input type="text" id="buscador" placeholder="Buscar cÃ³digo..." onkeyup="filtrar()">
  <button onclick="exportar()">ðŸ’¾ Guardar en Excel</button>
  <button onclick="toggleCarrito()">ðŸ›’ Ver carrito</button>
  <div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<h2>Datos del pedido</h2>
RazÃ³n Social:<br>
<input type="text" id="razon"><br><br>
Fecha:<br>
<input type="date" id="fecha"><br><br>
Observaciones:<br>
<textarea id="obs" rows="3"></textarea>

<hr>

<h3 id="tituloCarga">Cargar stock.csv</h3>
<input type="file" id="archivo" accept=".csv">
<div id="estado"></div>

<hr>

<div id="catalogo" class="grid"></div>

<div id="carritoBox">
  <h3>ðŸ›’ Carrito</h3>
  <div id="lista">VacÃ­o</div>
</div>

<script>
let productos=[], carrito=[];

/* ===== CARGA AUTOMÃTICA ===== */
window.addEventListener("load",()=>{
  fetch("stock.csv")
    .then(r=>{ if(!r.ok) throw "no"; return r.text(); })
    .then(txt=>{ estado.innerText="Stock cargado âœ”"; cargarCSV(txt); })
    .catch(()=>{ estado.innerText="Seleccione el archivo CSV"; });
});

/* ===== CARGA MANUAL ===== */
archivo.addEventListener("change",function(){
  const r=new FileReader();
  r.onload=()=>cargarCSV(r.result);
  r.readAsText(this.files[0]);
});

function cargarCSV(txt){
  productos=[]; carrito=[];
  catalogo.innerHTML=""; lista.innerHTML="VacÃ­o";
  actualizarResumen();

  txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
  const filas=txt.split("\n"); filas.shift();

  filas.forEach((f,i)=>{
    const c=f.split(";");
    const codigo=c[0]?.trim();
    const precio=parseFloat(c[1]?.replace(",","."));
    if(codigo && !isNaN(precio))
      productos.push({id:i,codigo,precio,img:"FOTOS/"+codigo+".jpg"});
  });

  archivo.style.display="none";
  tituloCarga.style.display="none";
  dibujar();
}

function dibujar(){
  catalogo.innerHTML=productos.map(p=>`
    <div class="card" data-codigo="${p.codigo.toUpperCase()}">
      <div class="codigo-barra">${p.codigo}</div>
      <div class="card-contenido">
        <img src="${p.img}" onerror="this.style.display='none'">
        <div class="precio">$ ${p.precio.toFixed(2)}</div>
        <input type="number" min="0" value="0" id="q${p.id}" onchange="cambiar(${p.id})">
      </div>
    </div>`).join("");
}

function filtrar(){
  const t=buscador.value.toUpperCase();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display=c.dataset.codigo.includes(t)?"block":"none";
  });
}

function cambiar(id){
  const i=document.getElementById("q"+id);
  const cant=parseInt(i.value)||0;
  const p=productos.find(x=>x.id===id);
  const it=carrito.find(x=>x.id===id);

  if(cant<=0){
    carrito=carrito.filter(x=>x.id!==id);
    i.classList.remove("seleccionado");
  }else{
    it ? it.cant=cant : carrito.push({id,codigo:p.codigo,cant,precio:p.precio});
    i.classList.add("seleccionado");
  }
  mostrarCarrito(); actualizarResumen();
}

function mostrarCarrito(){
  if(!carrito.length){ lista.innerText="VacÃ­o"; return; }
  let t=0;
  lista.innerHTML="<table><tr><th>CÃ³digo</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>"+
    carrito.map(i=>{
      const s=i.cant*i.precio; t+=s;
      return `<tr><td>${i.codigo}</td><td>${i.cant}</td><td>${i.precio}</td><td>${s.toFixed(2)}</td></tr>`;
    }).join("")+
    `<tr><td colspan="3"><b>Total</b></td><td><b>${t.toFixed(2)}</b></td></tr></table>`;
}

function actualizarResumen(){
  let c=0,t=0;
  carrito.forEach(i=>{c+=i.cant; t+=i.cant*i.precio;});
  resumen.innerText=`Cantidad: ${c} | Total: $ ${t.toFixed(2)}`;
}

function toggleCarrito(){
  carritoBox.style.display=carritoBox.style.display==="block"?"none":"block";
}

/* ===== EXPORTAR XLSX ===== */
function exportar(){
  if(!carrito.length){ alert("Carrito vacÃ­o"); return; }

  const wsData=[
    ["PEDIDO RELOJES CASIO"],
    ["RazÃ³n Social:", razon.value],
    ["Fecha:", fecha.value],
    ["Observaciones:", obs.value],
    [],
    ["CÃ³digo","Cantidad","Precio","Subtotal"]
  ];

  carrito.forEach(i=>{
    wsData.push([i.codigo,i.cant,i.precio,i.cant*i.precio]);
  });

  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(wsData);

  ws["A1"].s={ font:{ bold:true, sz:14 } };

  XLSX.utils.book_append_sheet(wb,ws,"Pedido");
  XLSX.writeFile(wb,"Pedido_Relojes.xlsx");
}
</script>

</body>
</html>
