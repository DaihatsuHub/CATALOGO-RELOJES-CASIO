<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo Relojes</title>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:100px 20px 20px 20px;}

/* ===== TOP BAR ===== */
#topbar{
  position:fixed;top:0;left:0;right:0;
  background:#222;color:#fff;padding:10px;
  display:flex;gap:10px;align-items:center;
  z-index:1000;
}
#topbar button{padding:6px 12px;cursor:pointer;}
#resumen{margin-left:auto;font-weight:bold;}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
  gap:10px;
}
.card{
  border:1px solid #000;
  padding:6px;
  text-align:center;
}
.codigo{
  background:#bfe6ff;
  font-weight:bold;
  padding:3px;
  border-bottom:1px solid #000;
}
.card img{
  width:auto;
  max-width:100%;
  height:160px;
  object-fit:contain;
  margin:5px 0;
  transition:transform .3s;
}
.card:hover img{ transform:scale(1.5); }

.precio{font-weight:bold;margin:5px 0;}
input[type=number]{width:70px;}
.seleccionado{background:orange;}

/* ===== MODAL ===== */
#modal{
  display:none;
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  z-index:2000;
}
#modalContent{
  background:#fff;width:90%;max-width:600px;
  margin:80px auto;padding:15px;border-radius:8px;
}
#cerrar{float:right;cursor:pointer;font-size:18px;}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}

.boton-activo{background:green !important;color:#fff !important;}
</style>
</head>

<body>

<div id="topbar">
  <b>üì¶ Cat√°logo</b>
  <input type="text" id="busqueda" placeholder="Buscar c√≥digo..." oninput="filtrar()">
  <button id="btnPDF">üìÑ Pedido PDF</button>
  <button id="btnCatalogo">üì• Descargar Cat√°logo</button>
  <button id="btnCarrito">üõí Ver carrito</button>
  <div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<h2>Datos del pedido</h2>
Raz√≥n Social:<br>
<input type="text" id="razon"><br><br>
Fecha:<br>
<input type="date" id="fecha"><br><br>
Observaciones:<br>
<textarea id="obs" rows="3"></textarea>

<hr>
<div id="estado"></div>
<div id="catalogo" class="grid"></div>

<!-- MODAL -->
<div id="modal">
  <div id="modalContent">
    <span id="cerrar">‚ùå</span>
    <h3>üõí Carrito</h3>
    <div id="lista">Vac√≠o</div>
  </div>
</div>

<script>
const btnPDF = document.getElementById("btnPDF");
const btnCatalogo = document.getElementById("btnCatalogo");
const btnCarrito = document.getElementById("btnCarrito");
const modal = document.getElementById("modal");
const cerrar = document.getElementById("cerrar");
const resumen = document.getElementById("resumen");
const lista = document.getElementById("lista");
const catalogo = document.getElementById("catalogo");
const estado = document.getElementById("estado");
const busqueda = document.getElementById("busqueda");

let productos=[], carrito=[];
fecha.value = new Date().toISOString().split("T")[0];

/* ===== CARGA CSV ===== */
window.addEventListener("load",()=>{
 fetch("stock.csv")
 .then(r=>r.text())
 .then(txt=>{estado.innerText="Stock cargado ‚úî"; cargarCSV(txt);})
 .catch(()=>estado.innerText="No se pudo cargar stock");
});

function cargarCSV(txt){
 productos=[]; carrito=[];
 catalogo.innerHTML=""; lista.innerHTML="Vac√≠o"; actualizarResumen();

 txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
 const filas=txt.split("\n"); filas.shift();

 filas.forEach((f,i)=>{
  const c=f.split(";");
  if(c.length<2) return;
  const codigo=c[0].trim();
  const precio=parseFloat(c[1].replace(",","."))||0;
  const carpeta = codigo[0].toUpperCase()>="M" ? "FOTOS2" : "FOTOS";
  productos.push({id:i,codigo,precio,img:carpeta+"/"+codigo+".jpg"});
 });
 dibujar();
}

function dibujar(){
 catalogo.innerHTML = productos.map(p=>`
 <div class="card">
   <div class="codigo">${p.codigo}</div>
   <img src="${p.img}" onerror="this.style.display='none'">
   <div class="precio">$ ${p.precio.toFixed(2)}</div>
   <input type="number" min="0" value="0" id="q${p.id}" onchange="cambiar(${p.id})">
 </div>`).join("");
}

function cambiar(id){
 const i=document.getElementById("q"+id);
 const cant=parseInt(i.value)||0;
 const p=productos.find(x=>x.id===id);
 carrito=carrito.filter(x=>x.id!==id);

 if(cant>0){
  carrito.push({id,codigo:p.codigo,cant,precio:p.precio});
  i.classList.add("seleccionado");
 }else i.classList.remove("seleccionado");

 mostrarCarrito(); actualizarResumen();
}

function mostrarCarrito(){
 if(!carrito.length){ lista.innerText="Vac√≠o"; return; }
 let total=0;
 lista.innerHTML=`
 <table>
 <tr><th>C√≥digo</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>
 ${carrito.map(i=>{
  const s=i.cant*i.precio; total+=s;
  return `<tr><td>${i.codigo}</td><td>${i.cant}</td><td>$ ${i.precio.toFixed(2)}</td><td>$ ${s.toFixed(2)}</td></tr>`;
 }).join("")}
 <tr><td colspan="3"><b>Total</b></td><td><b>$ ${total.toFixed(2)}</b></td></tr>
 </table>`;
}

function actualizarResumen(){
 let c=0,t=0;
 carrito.forEach(i=>{c+=i.cant; t+=i.cant*i.precio});
 resumen.innerText=`Cantidad: ${c} | Total: $ ${t.toFixed(2)}`;
 btnPDF.classList.toggle("boton-activo",t>0);
 btnCarrito.classList.toggle("boton-activo",t>0);
}

btnCarrito.onclick=()=>modal.style.display="block";
cerrar.onclick=()=>modal.style.display="none";

function filtrar(){
 const txt=busqueda.value.toLowerCase();
 document.querySelectorAll(".card").forEach(c=>{
  c.style.display=c.querySelector(".codigo").innerText.toLowerCase().includes(txt)?"":"none";
 });
}

/* ===== PDF PEDIDO ===== */
btnPDF.onclick = () => {
 if(!carrito.length){ alert("Carrito vac√≠o"); return; }
 if(!razon.value.trim()){ alert("Ingrese Raz√≥n Social"); return; }

 const { jsPDF } = window.jspdf;
 const doc = new jsPDF("p","mm","a4");
 let y=15;

 doc.setFont("helvetica","bold");
 doc.setFontSize(14);
 doc.text("PEDIDO RELOJES CASIO",10,y); y+=8;
 doc.setFontSize(10);
 doc.text("Raz√≥n Social: "+razon.value,10,y); y+=6;
 doc.text("Fecha: "+fecha.value,10,y); y+=6;
 doc.text("Observaciones: "+obs.value,10,y); y+=10;

 doc.setFont("helvetica","bold");
 doc.text("C√≥digo",10,y); doc.text("Cant",70,y);
 doc.text("Precio",100,y); doc.text("Subtotal",140,y);
 y+=4;

 doc.setFont("helvetica","normal");
 let total=0;
 carrito.forEach(p=>{
  let sub=p.cant*p.precio; total+=sub;
  doc.text(p.codigo,10,y);
  doc.text(String(p.cant),70,y);
  doc.text("$ "+p.precio.toFixed(2),100,y);
  doc.text("$ "+sub.toFixed(2),140,y);
  y+=6;
  if(y>270){ doc.addPage(); y=15; }
 });

 doc.setFont("helvetica","bold");
 doc.text("TOTAL: $ "+total.toFixed(2),10,y+5);
 doc.save("PEDIDO_"+razon.value.replace(/\s+/g,"_")+"_"+fecha.value+".pdf");
};

/* ===== PDF CAT√ÅLOGO ===== */
btnCatalogo.onclick = async ()=>{
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF("p","mm","a4");
 const cols=7;
 const w=27, h=40;
 let x=10, y=10, col=0;

 for(const p of productos){
  if(col>=cols){ col=0; x=10; y+=h+5; }
  if(y>270){ doc.addPage(); y=10; }

  // caja
  doc.rect(x,y,w,h);

  // fondo celeste codigo
  doc.setFillColor(191,230,255);
  doc.rect(x,y,w,6,"F");
  doc.setFontSize(7);
  doc.text(p.codigo,x+1,y+4);

  // imagen
  try{
    const img = await fetch(p.img).then(r=>r.blob());
    const base64 = await new Promise(res=>{
      const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(img);
    });
    doc.addImage(base64,"JPEG",x+2,y+8,w-4,22);
  }catch{}

  // precio
  doc.setFontSize(8);
  doc.text("$ "+p.precio.toFixed(2),x+2,y+h-3);

  x+=w+2; col++;
 }
 doc.save("CATALOGO_CASIO.pdf");
};
</script>

</body>
</html>
