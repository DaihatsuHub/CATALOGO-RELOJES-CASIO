<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo Relojes</title>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;margin:100px 20px 20px 20px;}
#topbar{
  position:fixed;top:0;left:0;right:0;
  background:#222;color:#fff;padding:10px;
  display:flex;gap:10px;align-items:center;z-index:1000;
}
#topbar button{padding:6px 12px;cursor:pointer;}
#resumen{margin-left:auto;font-weight:bold;}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;}
.card{border:1px solid #ccc;padding:10px;text-align:center;overflow:visible;}
.codigo{background:#bfe6ff;font-weight:bold;padding:4px;}
.card img{max-width:100%;height:160px;object-fit:contain;margin:6px 0;transition:.3s;}
.card:hover img{transform:scale(1.5);}
.precio{font-weight:bold;margin:6px 0;}
input[type=number]{width:70px;}
.seleccionado{background:orange;}

.boton-activo{background:green !important;color:#fff !important;}

#modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:2000;}
#modalContent{background:#fff;width:90%;max-width:700px;margin:80px auto;padding:15px;border-radius:8px;}
#cerrar{float:right;cursor:pointer;}

table{width:100%;border-collapse:collapse;}
th,td{border:1px solid #ccc;padding:6px;text-align:center;}
</style>
</head>

<body>

<div id="topbar">
  <b>üì¶ Cat√°logo</b>
  <input id="busqueda" placeholder="Buscar c√≥digo..." oninput="filtrar()">
  <button id="btnPDF">üìÑ Guardar pedido PDF</button>
  <button id="btnCatalogo">üìò Descargar Cat√°logo</button>
  <button id="btnCarrito">üõí Ver carrito</button>
  <div id="resumen">Cantidad: 0 | Total: $ 0.00</div>
</div>

<h3>Datos del pedido</h3>
Raz√≥n Social:<br><input id="razon"><br><br>
Fecha:<br><input type="date" id="fecha"><br><br>
Observaciones:<br><textarea id="obs" rows="3"></textarea>
<hr>

<div id="estado"></div>
<div id="catalogo" class="grid"></div>

<div id="modal">
  <div id="modalContent">
    <span id="cerrar">‚ùå</span>
    <h3>Carrito</h3>
    <div id="lista">Vac√≠o</div>
  </div>
</div>

<script>
const btnPDF=document.getElementById("btnPDF");
const btnCatalogo=document.getElementById("btnCatalogo");
const btnCarrito=document.getElementById("btnCarrito");
const modal=document.getElementById("modal");
const cerrar=document.getElementById("cerrar");
const resumen=document.getElementById("resumen");
const lista=document.getElementById("lista");
const catalogo=document.getElementById("catalogo");
const estado=document.getElementById("estado");
const busqueda=document.getElementById("busqueda");

let productos=[],carrito=[];

/* ===== FECHA SEGURA ===== */
window.addEventListener("load",()=>{
  const f=document.getElementById("fecha");
  if(f) f.value=new Date().toISOString().split("T")[0];
});

/* ===== CARGA CSV ===== */
window.addEventListener("load",()=>{
  fetch("stock.csv")
    .then(r=>{
      if(!r.ok) throw "No existe stock.csv";
      return r.text();
    })
    .then(txt=>{
      estado.innerHTML="‚úÖ Stock cargado autom√°ticamente";
      cargarCSV(txt);
    })
    .catch(e=>{
      estado.innerHTML="‚ùå ERROR cargando stock.csv<br>"+e;
      console.error(e);
    });
});

function cargarCSV(txt){
  productos=[];carrito=[];
  catalogo.innerHTML="";
  lista.innerHTML="Vac√≠o";
  actualizarResumen();

  txt=txt.replace(/^\uFEFF/,"").replace(/\r/g,"").trim();
  const filas=txt.split("\n");
  filas.shift();

  filas.forEach((f,i)=>{
    const c=f.split(";");
    if(c.length<2) return;

    const codigo=c[0].trim();
    const precio=parseFloat(c[1].replace(",","."))||0;

    const letra=codigo.charAt(0).toUpperCase();
    const carpeta=(letra>="M"&&letra<="Z")?"FOTOS2":"FOTOS";

    productos.push({id:i,codigo,precio,img:carpeta+"/"+codigo+".jpg"});
  });

  dibujar();
}

function dibujar(){
  catalogo.innerHTML=productos.map(p=>`
    <div class="card">
      <div class="codigo">${p.codigo}</div>
      <img src="${p.img}" onerror="this.style.display='none'">
      <div class="precio">$ ${p.precio.toFixed(2)}</div>
      <input type="number" min="0" value="0" id="q${p.id}" oninput="cambiar(${p.id})">
    </div>
  `).join("");
}

function cambiar(id){
  const input=document.getElementById("q"+id);
  const cant=parseInt(input.value)||0;
  const p=productos.find(x=>x.id===id);

  carrito=carrito.filter(x=>x.id!==id);
  if(cant>0){
    carrito.push({id,codigo:p.codigo,cant,precio:p.precio});
    input.classList.add("seleccionado");
  }else input.classList.remove("seleccionado");

  mostrarCarrito();
  actualizarResumen();
}

function mostrarCarrito(){
  if(!carrito.length){lista.innerText="Vac√≠o";return;}
  let total=0;
  lista.innerHTML=`
  <table>
  <tr><th>C√≥digo</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th></tr>
  ${carrito.map(i=>{
    const s=i.cant*i.precio; total+=s;
    return `<tr><td>${i.codigo}</td><td>${i.cant}</td><td>$ ${i.precio}</td><td>$ ${s.toFixed(2)}</td></tr>`;
  }).join("")}
  <tr><td colspan="3"><b>Total</b></td><td><b>$ ${total.toFixed(2)}</b></td></tr>
  </table>`;
}

function actualizarResumen(){
  let c=0,t=0;
  carrito.forEach(i=>{c+=i.cant;t+=i.cant*i.precio});
  resumen.innerText=`Cantidad: ${c} | Total: $ ${t.toFixed(2)}`;
  btnPDF.classList.toggle("boton-activo",t>0);
  btnCatalogo.classList.toggle("boton-activo",t>0);
  btnCarrito.classList.toggle("boton-activo",t>0);
}

btnCarrito.onclick=()=>modal.style.display="block";
cerrar.onclick=()=>modal.style.display="none";

function filtrar(){
  const txt=busqueda.value.toLowerCase();
  document.querySelectorAll(".card").forEach(c=>{
    c.style.display=c.querySelector(".codigo").innerText.toLowerCase().includes(txt)?"":"none";
  });
}

/* ===== CATALOGO PDF ===== */
btnCatalogo.onclick=async()=>{
  btnCatalogo.innerText="Grabando...";
  btnCatalogo.style.background="red";

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF("p","mm","a4");

  const cols=7;
  const cellW=190/cols;
  const cellH=42;
  let x=10,y=10,col=0;

  for(const p of productos){
    doc.rect(x,y,cellW,cellH);
    doc.setFillColor(191,230,255);
    doc.rect(x,y,cellW,7,"F");
    doc.setFont("helvetica","bold");
    doc.setFontSize(8);
    doc.text(p.codigo,x+cellW/2,y+5,{align:"center"});

    try{
      const img=await fetch(p.img).then(r=>r.blob()).then(b=>new Promise(res=>{
        const fr=new FileReader();
        fr.onload=()=>res(fr.result);
        fr.readAsDataURL(b);
      }));
      doc.addImage(img,"JPEG",x+3,y+9,cellW-6,20,undefined,"FAST");
    }catch{}

    doc.text("$ "+p.precio.toFixed(2),x+cellW/2,y+33,{align:"center"});

    col++; x+=cellW;
    if(col==cols){col=0;x=10;y+=cellH;if(y>260){doc.addPage();y=10;}}
  }

  doc.save("CATALOGO_RELOJES.pdf");
  btnCatalogo.innerText="üìò Descargar Cat√°logo";
  actualizarResumen();
};
</script>

</body>
</html>
